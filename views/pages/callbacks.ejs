<!DOCTYPE html>
<html>
<head>
  <%- include ("../partials/header.ejs") %>
  <style>
    #button{
      display:block;
      margin:20px auto;
      padding:10px 30px;
      background-color:#eee;
      border:solid #ccc 1px;
      cursor: pointer;
    }
    #overlay{	
      position: fixed;
      top: 0;
      z-index: 100;
      width: 100%;
      height:100%;
      display: none;
      background: rgba(0,0,0,0.6);
    }
    .cv-spinner {
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;  
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px #ddd solid;
      border-top: 4px #2e93e6 solid;
      border-radius: 50%;
      animation: sp-anime 0.8s infinite linear;
    }
    @keyframes sp-anime {
      100% { 
        transform: rotate(360deg); 
      }
    }
    .is-hide{
      display:none;
    }

  </style>
</head>

<body>

<%- include ("../partials/nav.ejs") %>
<div id="overlay">
  <div class="cv-spinner">
    <span class="spinner"></span>
  </div>
</div>
<div class="container">
  <h2>Callbacks Results</h2>
  <div>
    <form action="">
      New Callback Name: <input type="text" id="callbackName">
      <button type="button" id="btnNuevo">Crear</button>
    </form>
  </div>

  <table id="tableContent">
    <tr>
      <th>Id</th>
      <th>Name</th>
      <th>Status</th>
    </tr>
    <% results.forEach(function(r) { %>
    <tr>
      <td>
        <% if(r.callbackid){ %>
          <%= r.callbackid %>
        <% }else{ %>
          <button type="button" class="sendToMC" data-cbid="<%= r.id %>">Send to MC</button>
        <% } %>
      </td>
      <td><a href="callbacks/<%= r.id %>"><%= r.callbackname %></a></td>
      <td>
        <% if(r.callbackid!=undefined && r.status==undefined){ %>
          <button type="button" class="verifyCB" data-cbid="<%= r.id %>">Verify</button>
        <% } else if(r.status=='verify'){ %>
          <button type="button" class="subscriptionCB" data-cbid="<%= r.id %>">Subscription</button>
        <% }else{ %>
          <%= r.status %>
        <% } %>
      </td>
    </tr>
    <% }); %>
  </table>
</div>
<script>
  $(document).ready(function(){

    $(document).ajaxSend(function() {
      $("#overlay").fadeIn(300);ã€€
    });
    
    $("#callbackName").on("keypress", function (event) { 
      var keyPressed = event.keyCode || event.which; 
      if (keyPressed === 13) { 
          event.preventDefault(); 
          return false; 
      }
    }); 

    $("#btnNuevo").click(function(){
      $("#btnNuevo").attr("disabled", true);
      cbName = $('#callbackName').val();
      console.log(cbName);
      $.get( "../api/callback/new/"+cbName, function( data ) {
        console.log( data );
        $("#overlay").fadeOut(300);
        location.reload(true);
      });
    });

    $(".sendToMC").click(function(){
      $(".sendToMC").attr("disabled", true);
      cbId = $(this).attr('data-cbid');
      console.log(cbId);
      $.get( "../api/callback/send/"+cbId, function( data ) {
        console.log( data );
        $("#overlay").fadeOut(300);
        location.reload(true);
      });
    });

    $(".verifyCB").click(function(){
      $(".verifyCB").attr("disabled", true);
      cbId = $(this).attr('data-cbid');
      console.log(cbId);
      $.get( "../api/callback/verify/"+cbId, function( data ) {
        console.log( data );
        $("#overlay").fadeOut(300);
        location.reload(true);
      });
    });

    $(".subscriptionCB").click(function(){
      $(".subscriptionCB").attr("disabled", true);
      cbId = $(this).attr('data-cbid');
      console.log(cbId);
      $.get( "../api/callback/subscription/new/"+cbId, function( data ) {
        console.log( data );
        $("#overlay").fadeOut(300);
        location.reload(true);
      });
    });
    

  });
</script>
</body>
</html>
